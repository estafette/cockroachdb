builder:
  track: dev

labels:
  app-group: estafette-ci
  team: estafette-team
  language: helm

version:
  semver:
    major: 1
    minor: 0
    patch: 0
    labelTemplate: '{{branch}}-{{auto}}'
    releaseBranch: 1.0.0

env:
  GCLOUD_KEY_FILE: estafette.secret(DkhP7YHibRM3H5_L.Q0klhtaw1rWf_IxtdAeZG7MAMHHINDvW_3cLBapY-o-q2HYLKvTqmUHF9Ka5F00DPQkVg5XAsfU3Kld4rtjr2cUvWUvoaMhahapUK0wLHFggOjAoTs6CDvzuv1MczcpLVrJnc9_GCXTnmBy5v4hcu9EXAT7nDwlpZCbIIqaZIbDbIxh7lphJ7CoN3yGxSb7UVKHbYo3ViPX6YCkA6ijxc4qAWNjasqAAUv-C_U1mM1FrcvNoaZ7Fr5W_22Yd5K7gK3qi_q3HfvQYL6oBjiVu163ujSSwJBnNxgJguktFiFknl2w8XS064OjqWP4exq6LBCTJXF6keKOPdo6ulG7IkVA0ohPZKBhZgY-y96ZFjZleJeO0U5W1kI-JV0MvwYJFVU-asLjh_09MLFN12_gF2yKXp8hXvANCrVg2ofX_dbYzJcEaXlLJbZZ0yjV6ZErx9QGrZOz4UpW_qYj8OxnNZCCdv0Lv61reJteRziGLKV9N8t1FadQOi4rog4Iw-S-TVAHIB5RfKuqO5ovEEoreN10cCn8mE2gZFP2tURs0q5ZkMYK5BadDz-zgc6AkE0oDVm9zvEAlwNAF8ANevw-oGjgQfwXy-HV6Jl3_-DkXGtTxEjEmZmVV-rtAsbxAvCpdrRpLAhVFo9Mst2wgKmt0dKfcUFUNrGAOq__TiCV2ijCfDFTzxVTJKOLVzVnkk-p0cHRscXDZ-fKyX9IJcSIm0UjbTMhjiEIEJPJBPfVAlnKmLDkQy0vKp61BqhFenThfj8i4HltUE3G2vP8rGGmZTkimz0DGVRQxK3IUsxxXg2S5C2TU5Ic1XSPGo4wfpb0goo0PBua3tAjvYVuFdEh_JccFfE_Okh1Tu7NBEdgukGs20OGudDot_SeZEqkjEJyKie9hZIInqMGsc1tgCGntvctvRA8AC6BzdzaaqgAzxt2aGzPqedfcI368e77fRxXbzFTt8pL865VcxM2fZ4rYDO5sVioa41LGsjCQRoek_uNA9JXuTDpPIi3WK5WozcmVzFdPXzE5fG7rxP4CMRFw3hZ7OCqVwDj7UqFd1jirUKAm90bc3hb_SW3F1E6elS1oVXob4Bz7hdg8Y-P9psdY2OxUGRO3No3PldQ6V4OIM9n7uECbO8m4etuskgPk5f7V_q-JO9-HAGUPLFcBxEgQ8TwDfc5NmZSRUERNFt_3fSTOfpq38IgM3184HEjV57fTHvhy7VD-9T3sjlrtWavJScMKzWrJk0qufW-7_mircIKJE0nMqCyxWPgoXI7cHWgk_oAk5B1wOD74XGGYAzE--LwB2omoN1UjcWZgT1JlDWNd19p16bZspR-B1OeYBdPozhbPM637jQovFk3RXSdxLLsR99VtAJAKfL8-zCVrLROZrlvPmFTAunrZiNvjSTkPcjinGHF5PAYHNhn9iQPpM0KzL_AHuFG8DWJL_W0luDMnQktUWy-8IQ2sVqm-bIyvtDF9PGSTQHNVoTsmHhuM0FIfve19fy06OuQg-gf7pIyyHPvxPNoPvSnAIE0OCHkJqnLnlIBk3b8dG7dD5r_pWiYMtNIJtcwAIrJUmsC0U8OjX3BIfIt5-go2CwhnpqIZBT4ZrzhQ5d49j4Y0-e095sqWT9rqDlX8ogo7ZC0lOtHGYgOYVWndCg9SVLsLhSLYbI5xnQ9727JKr4EuoWL8gAfimLMzhkbugvGUwaHa6m2d6aVSfk9DNSxb7t7htiNndym63NtADaQC9yE1GnW3hHt-otH2C9n4e6AGprpx_x6S5gvFWmWEfAHWibTwIr-RdXm9HHlFJsh198db_G79Y1wmzASlIjwZ8bSeWTIzkcmlafODF-KY0TRhfICno3RnTzSdkJeIRLGycR2TvMM1wLrYi5bguvrPSYYpesXuOiI1AlW7-TbkHFyQ22nIZw1r_95oUKezVWGjmcwBNYANkjRpf0ae-Eact9iH6QWqf80Wx_dLY0nY-sZUSG35Gnf1HFQz_ZJSfl52UQTSwZp3d79X3hmBAnIlWivAt6IDmzhZ_qOAlOWyRxC95sJiN2eoUqMgwrEeqrobxQGrR6x9bQq61B-sXFGPGDmooSJc8a26bX3XrAFEKC3EMYoPppGupR3e-hI3FZdJGlcIvaj-dON1tVhS6VsTCfFOsf6HKkdUilkacvQBGLNUl4F3O4zpG66oDIi1_9fN0WZRkE_wLYw-bP79mKQht2r6IeJsIxx7J2t8WoN_kDmGcJc0kpTuX7urVZ4aBQ_1Sdj89wK1zMnoxxBSe4scNUwIvr4F1rH8MvVBTIJMyTxm2Dj5vm9cgUx9vn5hrRcbkpE0k_SbyBl0KBeR_8OArRAvawHUuyPFWJ3b-tVG5M5z48npIwbCVLChp7vjEHs5-Cxc5Bb0ezKmjksrhFIde3Nn2PVc9L6Ii25BcmXUUi6ngG3m21Z61o3AJ0wopC7dvJt2P6M8o3OiNa_V4myNByJi7rzHze36B2qEyzsifExTntzJLTSwsir4CNnei784o-cx5-Vu_oxDLmbi80WxWupk74ovoqkKEoWk39rVR67yvBCzgEHs0k7rWMksNIq-l0HMmL6EtkiHleWbb4LoIlULpMSeJWJiM8fmcXKIsFBJHwABkIsUTo0mEgJtmnGhoqY3MdHVfxaaQ9xM6TVn91MCI5U1i0bQeOAWpmeXupdF3Phwo8fcQriM5avqHaLqrr4uXwYkG5iRn5gxDLQU9EfHJuJx2gdd0hIj3aTrYTLbwF5XySgmGu5VpI5Qmr9mgFLy6wzWXHTFeLeZjtDfXwc8T32YvoVGsn_rSTJb8Y8DOQKi-QB0aqBLV0gbQfnbB__IxXOdJBFtmroj7nE3jLOaREuXemv7cfBua4Qf02dK-n7Ba2JWU2_i7WC_TwtbUBIGIFfKMPgvhozQdqUK-WOjxApNjGTN4mJApKWQiEGZYEmP3KWQ25tXwEIFJ1i13Ni1xp2l7kn96XT3R4h0wdk0atx2W3AXW5-ktXdWG0R8E-5lrkZ7O8VcIU8rcmoLCLz0yARQQhm1ULDCVmpKc3dN98zEGSqxKPUjFopTcXPtgTGk-KIBf3YOFW_1VqHXobQt31sycRVhKNuKNYhJpEQkOZz7VHZ0yJDsgmJ2OG2lbbZ74KaoQZV2PXTfFvqPgEFts6zg3bG4l0j2druVdcH8CK-WfVQn9zO9pTU10YtN0CtsbcPXWTrfGYoE1sTxDmKVR5DJZRfKGEnS-MkgKKUVQJuGaxznwaSMRw0MgR8NQlxUOruM7CV6yVVMmIsf5zuKQg9X1tOg514sqQeBYz-n9Z7mKsZAs1AZSe4rY60sOOQpHrjelkw-YDrPHFYFTYIRFQCV_vQ9Gja9Pfdblh088ogqSYU10rWeRDOEXQSl__eSpScb9GX8ctu6n70Hm_lZxqDABsIzkIEutekGy4WH6rP3e7k1ig_CgnioNqSTBImeWI38GdRjPBXNdNUVWY2zzge7tSGEDrlsliVY9I4HI8FdZ4aizrq8AThhYnfOqbDdAucQ_c_cT0N04xLtMELLvt5dXzXL9_-Ah2bfTObLVitRmtpYOD1Yfw7-iWEbvFTd60rzK2pjtRy4OnI2qOQ2VYwEH2GhwYFMFtTOLapkyQRpyJjwrtFMXlCGzacszNEO9U4ocFfS1994TgsCGTQbB9Tjkm5m28jK4JcWE3ziLavWrn1LUoCOGqx9fJYmQpBpPFlFCa03jyKO2Xyo5ekNvOHi8ud3HQf0wMw-QQ1265SwaQSuqqnIzw216kJG55fcVeSJvpVwjoNpvTV8mInYrdzlmQFnZzJMIHsFsngRbFfPY0-f5I4NG9ti6Qy4BCq64YHoWQVHPYfiac05TuM5SFMDPEjipqT9P8EsaYXYXPEZz3YQrTrsWKLaL2D7OjUsk64VbO4CE1RH6OIa8IK-_g_IN5toCHnZ5V18K7askGCoDk2mSdDPjC9kvhhXhmevfMMKAQTJupJnzUVy4Y2jJfFuSTj68Zr6yGXSo9adwxvf9VqYEVurTYLNuwrtyAC9x-0FFfCn5lsmrNPXBlvUilNW9vm1qt78Sr2kPsWJIcx6gNQ94TLKa3WUJHOhHu976xNEUElJtoT4gEbs3zfKjVZTd1MWi2khTqV1MJAM6GwMvtNcYM8j8N0HNzDPvf9Xeast9rRvtWDNZ7X1xvHw6_pIaEicgwcvGv9fOfXUEz8P4Bfk4ogs7cof_OjPlj7rkoLAk0QGBnBMesKoKpHfGU6gPA==)
  GCLOUD_SA_NAME: estafette.secret(dTj9MkqIHLqM7rVU.O6Enzm0A5USM43aAJ9zWmYe5L8f9HXSMjQACck24DcUtFylL0c0tkE723IXLjkcwMecin_kSg16ok1U6_uYEynOagxzGoQ_WcqfanT_7zBtSPxPgEPRO)
  GCLOUD_PROJECT_NAME: estafette.secret(BmdGMBT2lalsPp7Q.uLx3rQPGO4snBlRDcUh2hQB76TRfREvGZcYQzUK2QVVOtQEueZQ=)
  GCLOUD_GKE_CLUSTER_NAME: estafette.secret(tgsulzRvtjkXoHWT.LMn2jrcnGwRWLLk6vZUV7AqenVuU3EI=)
  GCLOUD_GKE_ZONE: estafette.secret(WrjS-oxlbTqMprdg.kdlCnbAW4bFkE6cQw-16jMddBe7WY3NBb9uIZh5g)
  APP_NAME: cockroachdb
  NAMESPACE: estafette
  TEAM_NAME: estafette
  HOSTNAMES: estafette.secret(0JGttv0haO1F4r_v.12nJe8twdMf_pVBBmzjsEAPrc5zYy2MXR74_hLt5-Oq5MyRq1MTGAZbb9H6bdpfd)
  COCKROACHDB_VERSION: v19.2.5
  REPLICAS: 7
  CPU_REQUEST: 2000m
  CPU_LIMIT: 4000m
  MEMORY_REQUEST: 18Gi
  MEMORY_LIMIT: 18Gi
  STORAGE_CLASS: fast
  PVC_SIZE: 10Gi
  LOCALITY: continent=europe,country=belgium,region=europe-west1,zone=europe-west1-c

stages:
  build-lint-and-package:
    parallelStages:
      validate-manifest:
        image: estafette/cloud-sdk:dev
        shell: /bin/bash
        commands:
        - echo "${GCLOUD_KEY_FILE}" | base64 -d > key-file.json
        - gcloud auth activate-service-account ${GCLOUD_SA_NAME} --key-file ./key-file.json
        - gcloud config set account ${GCLOUD_SA_NAME}
        - gcloud config set project ${GCLOUD_PROJECT_NAME}
        - gcloud container clusters get-credentials ${GCLOUD_GKE_CLUSTER_NAME} --zone ${GCLOUD_GKE_ZONE}
        - cat kubernetes.yaml | envsubst \$APP_NAME,\$NAMESPACE,\$TEAM_NAME,\$HOSTNAMES,\$COCKROACHDB_VERSION,\$REPLICAS,\$CPU_REQUEST,\$CPU_LIMIT,\$MEMORY_REQUEST,\$MEMORY_LIMIT,\$STORAGE_CLASS,\$PVC_SIZE,\$LOCALITY | kubectl apply --validate=true --dry-run=true -f -

      lint-helm-chart:
        image: extensions/helm:dev
        action: lint

      package-helm-chart:
        image: extensions/helm:dev
        action: package
        appVersion: v19.2.1

  # test-helm-chart:
  #   services:
  #   - name: kubernetes
  #     image: bsycorp/kind:latest-1.12
  #     readiness:
  #       path: /kubernetes-ready
  #       port: 10080
  #   image: extensions/helm:dev
  #   action: test
  #   values: |-
  #     replicaCount: 2
  #     storage: "100Mi"
  #     secret:
  #       valuesAreBase64Encoded: true
  #       # generated with
  #       # > openssl req -x509 -sha256 -nodes -days 1024 -newkey rsa:2048 -keyout certificate.key -out certificate.crt
  #       # > cat certificate.crt certificate.key | base64
  #       certificatePemFile: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURERENDQWZRQ0NRRFBPeGRLY3hQOXhqQU5CZ2txaGtpRzl3MEJBUXNGQURCSU1Rc3dDUVlEVlFRR0V3SkoKVHpFU01CQUdBMVVFQ2d3SlJYTjBZV1psZEhSbE1Rc3dDUVlEVlFRTERBSkRTVEVZTUJZR0ExVUVBd3dQWTJrdQpaWE4wWVdabGRIUmxMbWx2TUI0WERURTVNVEV4TWpFMk1UVXpPRm9YRFRJeU1Ea3dNVEUyTVRVek9Gb3dTREVMCk1Ba0dBMVVFQmhNQ1NVOHhFakFRQmdOVkJBb01DVVZ6ZEdGbVpYUjBaVEVMTUFrR0ExVUVDd3dDUTBreEdEQVcKQmdOVkJBTU1EMk5wTG1WemRHRm1aWFIwWlM1cGJ6Q0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQwpBUW9DZ2dFQkFLdzJGUEx5N2JSZlFoaDBwQSswVkMzSGplZzB6a2YxaGF4ZDNGM3ZyUHpUOC9IeVVFSFc3T0JXCmlVL2Jnb0dleTN2V3RPMGZDY1VtUTEvenZnSUIvbWlsRnRoMldyTmU4N1FMUEVQeXlMZ2FRVlZjYUxNUGtPOVkKZjZOSCs5RG9tOWhvVFhFbEJPUVYyMGt5a1BXKzZ2UUo1TEpETTA4Z0pJanJkUklzcFB0czRMUi9XUjFkbEM3WQpUYjhqTkVwblR6OFlLU0JYcGJzZ0o0d1A4UVhLbXJLRUlWaDFSNzBMM0Rwdmtoeld0eFVwZDdUanVtQkVPN0owCnJLN1VIRStpMDFmM1pRb0IrZFA2YWEyRWdsaDVoVzFlc2pIT3YrOXI0M010R2NVYklVVFJYRlRYQXhXN2V5UW8KVVhteU9PKzg4OTNwSVZEZDRQamdHZTZnTG9xMlBpa0NBd0VBQVRBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQQprWlZmeDM4RkRrUExGNC9WYzBvdVgyRTNVTC9GT3N5UTZDL3J3STE3aEIrdk1GMGZwaTlxMnJrMXBPc011THlvCm9oVTFRZ3R5TDRHMFdWTEh3b2ZoTS9rTlo3ZlZHWm9GYjNFbFZYODBuKzNZMFFmUTE5Q2pYMFo1MUxaTjY2N0gKUlFiQmhMOFZyU3BseTluN0xmZ2pZLzZKZ2VnS0hkQnowNWlwMFRENmFiaHkxbHVFM1FSNm4vTm5FVnhnQ3V6dQpqZnZzSmF4OUlGSnNrbVYrNXBvOUM5TTZ5eDJ5VWdNZXY4eHM4VzBsZTZLOGJGWG45cEk3ZE1LakFVNlZTQWFCCkVjai81YndNOHE0ODRoRXgzL1JkSkE3VS9pa3N2R3BjU0dlSVpaS0l1UG9FR0l5bVA3emtucE0xRVluSlc0TXMKY2FwVXVWNzUvQXNmL2VXNkMzbFM3QT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRQ3NOaFR5OHUyMFgwSVkKZEtRUHRGUXR4NDNvTk01SDlZV3NYZHhkNzZ6ODAvUHg4bEJCMXV6Z1ZvbFAyNEtCbnN0NzFyVHRId25GSmtOZgo4NzRDQWY1b3BSYllkbHF6WHZPMEN6eEQ4c2k0R2tGVlhHaXpENUR2V0gralIvdlE2SnZZYUUxeEpRVGtGZHRKCk1wRDF2dXIwQ2VTeVF6TlBJQ1NJNjNVU0xLVDdiT0MwZjFrZFhaUXUyRTIvSXpSS1owOC9HQ2tnVjZXN0lDZU0KRC9FRnlwcXloQ0ZZZFVlOUM5dzZiNUljMXJjVktYZTA0N3BnUkR1eWRLeXUxQnhQb3ROWDkyVUtBZm5UK21tdApoSUpZZVlWdFhySXh6ci92YStOekxSbkZHeUZFMFZ4VTF3TVZ1M3NrS0ZGNXNqanZ2UFBkNlNGUTNlRDQ0Qm51Cm9DNkt0ajRwQWdNQkFBRUNnZ0VBYkk0cTVucjhISmR2c3JyVU1KSWIvaitzMUpOMDlTZHYvQmV1c2doRG81eDQKU2l2Vks2dXY1anFtbEJCclZBb2xld3I5UWZ3dXpIZ3lRR29GZkg2RlFMSFFsT01HaWN0eEZDMkE3OVE3Y3RJYQpIUlVEYXR5RklGdEpHa1JtR0dxSTB3SHN6MFhtcjJDWHVxeUZkR1BFOTlERXVScGpYWjJGYWtvQ29sSkNMYnFMCnFnOWtPOHpUYThRUDZrQnZwWnIxQk1BL2pIaGFXK0J4clZaanZUVlNiNlA5UEduY3pLWnExZE9EU2NHekpadWoKNHBGNWFtZ1NBS0JPSVAwTzVMQW9aQ3FHckRQNi9odkg5K1VNVmdUSmRxUFJWU2ppZ3J1M2ZaNndDOU0wTVQ0TApySUJLZnJMdWh1Vmk0Z1Vpci81YUc1NDJwSFhDb2xoTjM2U1FtT01UZ1FLQmdRRFZyQ3FMQnJSeU5OVUMwRnNMCjVRZXRnUGRWMVc0YjhtNmtQbjZpR1ZBZUttMWpkaG9pOWJFSEVYNDQvbjRKMlM2Q0g5WlB4bFNOUU41Uy9uMjEKQ2ZweXpzVkJDWURYRjUyMzJHemQzdExCLzEwTHl6YnBjc0x4OHoveURMWDFUNytySzF2akFXRjVneXhOWk16RgpoUzU4S0t5OG0zMWJjTVM5TGtEbTlIS2Qzd0tCZ1FET1UxRlliZ0RpSzlhQkxWZVFRLzZBQ01FRmxMcC84UzJQCjZKWERabmt6SWFFU2pkYUdtTzhETUJkMnJub0NkTXl5a2I5UURpRGhqTmEwZ0JVUXplU1Q5NGVKKzhkSnNCLzYKZkN6VmZCK0hYOWhhNUw3QlpVV2lCanZMUDgrb0VCOWt3TFRpblRFVFVML2ZKeGIrNHJlbWl3dmxZczhnY3g1dgpQaTBDbUlXVTl3S0JnQUk0Wk1USEVBN3p2NWJrNVYxTlJ2UWxsK3hiYUdaLzhXaGhnZDFiVi9ySVJCUzVnSElHCmpZMWVRQ3FGY25mVnV1YjlQN1BhZ3J4cEJTWmxvSmJHQU1VNm90QVhNakNKL1VpUXhpalVET3FaSmJWZXFqWm8KeTkvSndFdGFtSFZ4RzdQQ29wVE1TZUFDWGU1Nzhxakd4b0hoeGxHN1orVVFXZXNCVlFsUlZ2T1BBb0dBTSt1cgprTUU5MzZ5QWNrbGl1NThnc0QrRHMwL1dEdFEyVHZ5TWszdDZERy91QktsRXp1STFZMnY2dTViMGhTRzNVVWgwCkNFVkY2UHgwRzBBUURRYUMrdWxUWmxuQnNMMXRqcThvNlNBdkh2WHprQXY0Sk5yRFJ4NmlkV2M5Ym1HQVJPNXAKbG8xUUNEaE4wRzRaejFKbVBMYkk2NVNONHZDVlBCRTlhbVhQVjhrQ2dZQmlEMGpPVEx3YVNRTHRscWl0OVdSSgpMK1pCeVlEYk40WE9VNEpweDFDeTdHUStPak5GdWtkZUZXejNBTko3L216MTlnMmV4NjB2cjhWeTVpdzhZQjZWCnpUOUxDRDNNb0dsblAyMUY5S29PZzA5UXgzRGFySTd5S3Y4STI5UG82T0M0dzJYazV2SER5MW1nRSt1aFFSZHoKRXB1QXo5aXpKN3c3dVlUOWI4YnVJZz09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
  #       # > cat certificate.key | base64
  #       certificateKeyFile: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFRQ3NOaFR5OHUyMFgwSVkKZEtRUHRGUXR4NDNvTk01SDlZV3NYZHhkNzZ6ODAvUHg4bEJCMXV6Z1ZvbFAyNEtCbnN0NzFyVHRId25GSmtOZgo4NzRDQWY1b3BSYllkbHF6WHZPMEN6eEQ4c2k0R2tGVlhHaXpENUR2V0gralIvdlE2SnZZYUUxeEpRVGtGZHRKCk1wRDF2dXIwQ2VTeVF6TlBJQ1NJNjNVU0xLVDdiT0MwZjFrZFhaUXUyRTIvSXpSS1owOC9HQ2tnVjZXN0lDZU0KRC9FRnlwcXloQ0ZZZFVlOUM5dzZiNUljMXJjVktYZTA0N3BnUkR1eWRLeXUxQnhQb3ROWDkyVUtBZm5UK21tdApoSUpZZVlWdFhySXh6ci92YStOekxSbkZHeUZFMFZ4VTF3TVZ1M3NrS0ZGNXNqanZ2UFBkNlNGUTNlRDQ0Qm51Cm9DNkt0ajRwQWdNQkFBRUNnZ0VBYkk0cTVucjhISmR2c3JyVU1KSWIvaitzMUpOMDlTZHYvQmV1c2doRG81eDQKU2l2Vks2dXY1anFtbEJCclZBb2xld3I5UWZ3dXpIZ3lRR29GZkg2RlFMSFFsT01HaWN0eEZDMkE3OVE3Y3RJYQpIUlVEYXR5RklGdEpHa1JtR0dxSTB3SHN6MFhtcjJDWHVxeUZkR1BFOTlERXVScGpYWjJGYWtvQ29sSkNMYnFMCnFnOWtPOHpUYThRUDZrQnZwWnIxQk1BL2pIaGFXK0J4clZaanZUVlNiNlA5UEduY3pLWnExZE9EU2NHekpadWoKNHBGNWFtZ1NBS0JPSVAwTzVMQW9aQ3FHckRQNi9odkg5K1VNVmdUSmRxUFJWU2ppZ3J1M2ZaNndDOU0wTVQ0TApySUJLZnJMdWh1Vmk0Z1Vpci81YUc1NDJwSFhDb2xoTjM2U1FtT01UZ1FLQmdRRFZyQ3FMQnJSeU5OVUMwRnNMCjVRZXRnUGRWMVc0YjhtNmtQbjZpR1ZBZUttMWpkaG9pOWJFSEVYNDQvbjRKMlM2Q0g5WlB4bFNOUU41Uy9uMjEKQ2ZweXpzVkJDWURYRjUyMzJHemQzdExCLzEwTHl6YnBjc0x4OHoveURMWDFUNytySzF2akFXRjVneXhOWk16RgpoUzU4S0t5OG0zMWJjTVM5TGtEbTlIS2Qzd0tCZ1FET1UxRlliZ0RpSzlhQkxWZVFRLzZBQ01FRmxMcC84UzJQCjZKWERabmt6SWFFU2pkYUdtTzhETUJkMnJub0NkTXl5a2I5UURpRGhqTmEwZ0JVUXplU1Q5NGVKKzhkSnNCLzYKZkN6VmZCK0hYOWhhNUw3QlpVV2lCanZMUDgrb0VCOWt3TFRpblRFVFVML2ZKeGIrNHJlbWl3dmxZczhnY3g1dgpQaTBDbUlXVTl3S0JnQUk0Wk1USEVBN3p2NWJrNVYxTlJ2UWxsK3hiYUdaLzhXaGhnZDFiVi9ySVJCUzVnSElHCmpZMWVRQ3FGY25mVnV1YjlQN1BhZ3J4cEJTWmxvSmJHQU1VNm90QVhNakNKL1VpUXhpalVET3FaSmJWZXFqWm8KeTkvSndFdGFtSFZ4RzdQQ29wVE1TZUFDWGU1Nzhxakd4b0hoeGxHN1orVVFXZXNCVlFsUlZ2T1BBb0dBTSt1cgprTUU5MzZ5QWNrbGl1NThnc0QrRHMwL1dEdFEyVHZ5TWszdDZERy91QktsRXp1STFZMnY2dTViMGhTRzNVVWgwCkNFVkY2UHgwRzBBUURRYUMrdWxUWmxuQnNMMXRqcThvNlNBdkh2WHprQXY0Sk5yRFJ4NmlkV2M5Ym1HQVJPNXAKbG8xUUNEaE4wRzRaejFKbVBMYkk2NVNONHZDVlBCRTlhbVhQVjhrQ2dZQmlEMGpPVEx3YVNRTHRscWl0OVdSSgpMK1pCeVlEYk40WE9VNEpweDFDeTdHUStPak5GdWtkZUZXejNBTko3L216MTlnMmV4NjB2cjhWeTVpdzhZQjZWCnpUOUxDRDNNb0dsblAyMUY5S29PZzA5UXgzRGFySTd5S3Y4STI5UG82T0M0dzJYazV2SER5MW1nRSt1aFFSZHoKRXB1QXo5aXpKN3c3dVlUOWI4YnVJZz09Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K

  clone-charts-repo:
    image: extensions/git-clone:dev
    repo: helm-charts
    branch: master

  publish-helm-chart:
    image: extensions/helm:dev
    action: publish

  slack-notify:
    image: extensions/slack-build-status:dev
    workspace: estafette
    channels:
    - '#build-status'
    when:
      status == 'succeeded' ||
      status == 'failed'

releases:
  release:
    stages:
      clone-charts-repo:
        image: extensions/git-clone:dev
        repo: helm-charts
        branch: master

      purge-prerelease-helm-charts:
        image: extensions/helm:dev
        action: purge

      create-github-release:
        image: extensions/github-release:dev

  tooling:
    clone: true
    stages:
      deploy:
        image: estafette/cloud-sdk:dev
        shell: /bin/bash
        commands:
        - echo "${GCLOUD_KEY_FILE}" | base64 -d > key-file.json
        - gcloud auth activate-service-account ${GCLOUD_SA_NAME} --key-file ./key-file.json
        - gcloud config set account ${GCLOUD_SA_NAME}
        - gcloud config set project ${GCLOUD_PROJECT_NAME}
        - gcloud container clusters get-credentials ${GCLOUD_GKE_CLUSTER_NAME} --zone ${GCLOUD_GKE_ZONE}
        - cat kubernetes.yaml | envsubst \$APP_NAME,\$NAMESPACE,\$TEAM_NAME,\$HOSTNAMES,\$COCKROACHDB_VERSION,\$REPLICAS,\$CPU_REQUEST,\$CPU_LIMIT,\$MEMORY_REQUEST,\$MEMORY_LIMIT,\$STORAGE_CLASS,\$PVC_SIZE,\$LOCALITY | kubectl apply -n ${NAMESPACE} -f -
        - kubectl rollout status sts/cockroachdb -n ${NAMESPACE}

  tooling-with-helm-diff:
    stages:
      diff:
        image: extensions/helm:dev
        credentials: gke-tooling
        action: diff
        namespace: estafette
        repoUrl: https://kubernetes-charts.storage.googleapis.com
        chart: cockroachdb
        version: 2.1.16
        appVersion: v19.2.1
        values: |-
          Name: "cockroachdb"
          ImageTag: "v19.1.5"
          ImagePullPolicy: "IfNotPresent"
          Replicas: 5
          Resources:
            limits:
              cpu: "4"
              memory: 12Gi
            requests:
              cpu: "1"
              memory: 12Gi
          Storage: "10Gi"
          StorageClass: "fast"
          CacheSize: "35%"
          MaxSQLMemory: "35%"
          Locality: "continent=europe,country=belgium,region=europe-west1,zone=europe-west1-c"